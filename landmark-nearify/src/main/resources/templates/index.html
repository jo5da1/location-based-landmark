<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Realtime Landmark Map</title>
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet/dist/leaflet.css"
    />
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"
    />
    <style>
        #map { height: 800px; width: 90%; }
    </style>
</head>
<body>
<h1>Realtime Landmark Map</h1>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    const map = L.map('map').setView([57.69463, 11.95506], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Layer for drawn items
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // Add draw control
    const drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: { polygon: false, polyline: false, circle: false, marker: false, circlemarker: false }
    });
    map.addControl(drawControl);

    // WebSocket setup
    let socket = new SockJS('/ws');
    let stompClient = Stomp.over(socket);

    stompClient.connect({}, function(frame) {
        console.log('Connected: ' + frame);

        stompClient.subscribe('/topic/landmarks', function(message) {
            const landmark = JSON.parse(message.body);
            L.marker([landmark.latitude, landmark.longitude])
                .addTo(map)
                .bindPopup(landmark.name);
        });
    });

    // Capture bounding box
    map.on(L.Draw.Event.CREATED, function (event) {
        const layer = event.layer;
        drawnItems.addLayer(layer);

        if (layer instanceof L.Rectangle) {
            const bounds = layer.getBounds();
            const bbox = {
                northEast: { lat: bounds.getNorthEast().lat, lng: bounds.getNorthEast().lng },
                southWest: { lat: bounds.getSouthWest().lat, lng: bounds.getSouthWest().lng }
            };
            console.log('Bounding Box:', bbox);

            // Send bbox to backend via WebSocket
            stompClient.send("/app/bbox", {}, JSON.stringify(bbox));
        }
    });
</script>
</body>
</html>
